name: CI

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-22.04
    env:
      JAX_ENABLE_X64: "True"
      JAX_DISABLE_JIT: "1"
      SFINCS_JAX_SOLVER_JIT: "0"
      SFINCS_JAX_PRECOMPILE: "0"
      SFINCS_JAX_PROFILE: "0"
      SFINCS_JAX_CI: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Tests
        run: |
          python -m pytest -q

  examples-smoke:
    runs-on: ubuntu-22.04
    env:
      JAX_ENABLE_X64: "True"
      JAX_DISABLE_JIT: "1"
      SFINCS_JAX_SOLVER_JIT: "0"
      SFINCS_JAX_PRECOMPILE: "0"
      SFINCS_JAX_PROFILE: "0"
      SFINCS_JAX_CI: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Smoke-run examples (no optional deps)
        run: |
          python examples/getting_started/build_grids_and_geometry.py
          python examples/getting_started/apply_collisionless_operator.py
          python examples/getting_started/write_sfincs_output_python.py
          python examples/getting_started/write_sfincs_output_cli.py
          python examples/parity/write_output_upstream_quick2species_python.py
          python examples/parity/write_output_upstream_quick2species_cli.py
          python examples/parity/geometry_scheme4_parity.py
          python examples/parity/collisionless_operator_matvec_parity.py
          python examples/autodiff/differentiable_geometry_gradients.py
          python examples/parity/solve_fortran_matrix_with_gmres.py
          python examples/parity/output_parity_cli_driver.py
          python examples/parity/output_key_coverage_report.py
          python examples/autodiff/matrix_free_residual_and_jvp.py
          python examples/parity/solve_scheme5_tiny_parity.py
          python examples/autodiff/autodiff_sensitivity_nu_n_scheme5.py
